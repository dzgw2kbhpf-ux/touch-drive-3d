<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Touch Drive City</title>

<style>
body { margin:0; overflow:hidden; background:black; touch-action:none; }
#ui { position:fixed; bottom:0; width:100%; height:40%; display:flex; }
.btn { flex:1; }
#accel, #brake {
  position:fixed; bottom:10px; width:80px; height:80px;
  border-radius:50%;
}
#accel { right:10px; background:rgba(0,255,0,0.3); }
#brake { right:100px; background:rgba(255,0,0,0.3); }
#speed {
  position:fixed; top:10px; left:10px;
  color:white; font-size:18px; font-family:monospace;
}
</style>
</head>

<body>
<div id="ui">
  <div id="left" class="btn"></div>
  <div id="right" class="btn"></div>
</div>
<div id="accel"></div>
<div id="brake"></div>
<div id="speed">0 km/h</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script>
/* ===== 基本 ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.4));
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);

/* ===== 車 ===== */
const car = new THREE.Mesh(
  new THREE.BoxGeometry(1,0.5,2),
  new THREE.MeshStandardMaterial({color:0xff3333})
);
car.position.y = 0.25;
scene.add(car);

/* ===== 道路 ===== */
const road = new THREE.Mesh(
  new THREE.PlaneGeometry(20,5000),
  new THREE.MeshStandardMaterial({color:0x333333})
);
road.rotation.x = -Math.PI/2;
scene.add(road);

/* ===== 操作 ===== */
let steering = 0;
let speed = 0;
const maxSpeed = 0.6;

left.ontouchstart = ()=> steering = 0.04;
right.ontouchstart = ()=> steering = -0.04;
left.ontouchend = right.ontouchend = ()=> steering = 0;

accel.ontouchstart = ()=> speed = Math.min(speed + 0.02, maxSpeed);
brake.ontouchstart = ()=> speed = Math.max(speed - 0.04, 0);

/* ===== 街ブロック ===== */
let blocks = [];
let nextZ = 0;
const blockSize = 40;

function spawnStreet(z){
  const g = new THREE.Group();
  for(let i=0;i<6;i++){
    const h = Math.random()*5+2;
    const b = new THREE.Mesh(
      new THREE.BoxGeometry(3,h,3),
      new THREE.MeshStandardMaterial({color:0x888888})
    );
    b.position.set(i<3?-7:7, h/2, z+(i%3)*6);
    g.add(b);
  }
  scene.add(g);
  blocks.push({z, group:g});
}

function spawnIntersection(z){
  const g = new THREE.Group();

  // 横断道路
  const cross = new THREE.Mesh(
    new THREE.PlaneGeometry(30,10),
    new THREE.MeshStandardMaterial({color:0x444444})
  );
  cross.rotation.x = -Math.PI/2;
  cross.position.z = z;
  g.add(cross);

  // 信号
  const pole = new THREE.Mesh(
    new THREE.BoxGeometry(0.2,3,0.2),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  pole.position.set(5,1.5,z+2);
  g.add(pole);

  const lightMesh = new THREE.Mesh(
    new THREE.SphereGeometry(0.3),
    new THREE.MeshStandardMaterial({color:0xff0000})
  );
  lightMesh.position.set(5,2.8,z+2);
  g.add(lightMesh);

  g.userData = { signal: lightMesh, timer:0, green:false };

  scene.add(g);
  blocks.push({z, group:g});
}

function updateCity(){
  if(car.position.z < nextZ){
    if(Math.random()<0.25) spawnIntersection(nextZ);
    else spawnStreet(nextZ);
    nextZ -= blockSize;
  }

  blocks = blocks.filter(b=>{
    if(car.position.z - b.z > 60){
      scene.remove(b.group);
      return false;
    }
    return true;
  });
}

/* ===== ループ ===== */
const speedEl = document.getElementById("speed");
function animate(){
  requestAnimationFrame(animate);

  speed *= 0.99;
  car.rotation.y += steering;
  car.translateZ(speed);

  updateCity();

  // 信号更新
  blocks.forEach(b=>{
    if(b.group.userData.signal){
      const d = b.group.userData;
      d.timer++;
      if(d.timer > 120){
        d.green = !d.green;
        d.signal.material.color.set(d.green ? 0x00ff00 : 0xff0000);
        d.timer = 0;
      }
    }
  });

  camera.position.lerp(
    new THREE.Vector3(
      car.position.x,
      car.position.y+5,
      car.position.z+10
    ),0.1
  );
  camera.lookAt(car.position);

  speedEl.textContent = Math.floor(speed*200)+" km/h";
  renderer.render(scene,camera);
}
animate();

window.onresize = ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
};
</script>
</body>
</html>
